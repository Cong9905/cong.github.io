<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dự Đoán Xu Hướng BTC/USDT</title>
    <style>
        .arrow {
            font-size: 30px;
            font-weight: bold;
        }
        .up-arrow {
            color: green;
        }
        .down-arrow {
            color: red;
        }
        canvas {
            max-width: 100%; /* Cho phép canvas co dãn theo chiều rộng của màn hình */
            height: auto;    /* Chiều cao tự động */
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
</head>
<body>
    <h1>Dự Đoán Xu Hướng BTC/USDT</h1>
    <label for="chartInterval">Chọn khoảng thời gian:</label>
    <select id="chartInterval">
        <option value="1m">1 Phút</option>
        <option value="30s">30 Giây</option>
    </select>

    <label for="option">Chọn số nến để tính toán:</label>
    <select id="option">
        <option value="14">14 Nến</option>
        <option value="3">3 Nến</option>
    </select>

    <button onclick="startAutoPrediction()">Bắt đầu dự đoán liên tục</button>
    <div id="countdownTimer">Thời gian đến dự đoán: 0s</div>
    <div id="result"></div>
    <div id="accuracy"></div>
    <canvas id="candleChart"></canvas>

    <script>
        let predictionInterval;
        let countdownInterval;
        let totalPredictions = 0;
        let correctPredictions = 0;
        let candleChart;

        async function fetchKlines(symbol, interval, limit) {
            const response = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`);
            const data = await response.json();
            return data;
        }

        function calculateRSI(prices, period = 14) {
            const gains = [];
            const losses = [];
            for (let i = 1; i < prices.length; i++) {
                const difference = prices[i] - prices[i - 1];
                if (difference > 0) gains.push(difference);
                else losses.push(-difference);
            }

            const avgGain = gains.slice(-period).reduce((a, b) => a + b, 0) / period || 0;
            const avgLoss = losses.slice(-period).reduce((a, b) => a + b, 0) / period || 0;

            const rs = avgGain / avgLoss;
            return 100 - (100 / (1 + rs));
        }

        function analyzeVolume(data) {
            const volumes = data.map(candle => parseFloat(candle[5]));
            return volumes.reduce((a, b) => a + b, 0) / volumes.length;
        }

        function predictTrend(rsi, avgVolume, lastVolume) {
            const bullishThreshold = 30;
            const bearishThreshold = 70;

            let trend = "";
            let probability = 0;

            if (rsi < bullishThreshold && lastVolume > avgVolume) {
                trend = "Tăng";
                probability = ((bullishThreshold - rsi) / bullishThreshold * 100).toFixed(2);
            } else if (rsi > bearishThreshold && lastVolume > avgVolume) {
                trend = "Giảm";
                probability = ((rsi - bearishThreshold) / bearishThreshold * 100).toFixed(2);
            } else {
                trend = "Không xác định";
                probability = 0;
            }

            return [trend, probability];
        }

        function renderChart(data) {
            const prices = data.map(candle => ({
                x: new Date(candle[0]),
                o: parseFloat(candle[1]),
                h: parseFloat(candle[3]),
                l: parseFloat(candle[4]),
                c: parseFloat(candle[4])
            }));

            if (candleChart) {
                candleChart.destroy();
            }

            const ctx = document.getElementById('candleChart').getContext('2d');
            candleChart = new Chart(ctx, {
                type: 'candlestick',
                data: {
                    datasets: [{
                        label: 'Candle',
                        data: prices,
                        borderColor: 'rgba(0, 0, 0, 1)',
                        backgroundColor: (context) => {
                            const { dataset, dataIndex } = context;
                            return dataset.data[dataIndex].o < dataset.data[dataIndex].c ? 'rgba(0, 255, 0, 0.5)' : 'rgba(255, 0, 0, 0.5)';
                        },
                    }]
                },
                options: {
                    responsive: true, // Biểu đồ sẽ phản hồi với kích thước màn hình
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        },
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'xy'
                            },
                            zoom: {
                                enabled: true,
                                mode: 'xy'
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'minute'
                            },
                            title: {
                                display: true,
                                text: 'Thời gian'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Giá'
                            }
                        }
                    }
                }
            });
        }

        async function makePrediction(option) {
            console.log("Thực hiện dự đoán với tùy chọn:", option);
            const limit = parseInt(option);
            const interval = document.getElementById("chartInterval").value;

            let data;
            try {
                data = await fetchKlines("BTCUSDT", interval, limit);
                if (!data.length) throw new Error("Không có dữ liệu nến.");
                renderChart(data); // Render biểu đồ sau khi lấy dữ liệu
            } catch (error) {
                console.error("Error fetching data:", error);
                document.getElementById("result").innerText = "Có lỗi xảy ra khi lấy dữ liệu.";
                return;
            }

            const prices = data.map(candle => parseFloat(candle[4]));
            const rsi = calculateRSI(prices);
            const avgVolume = analyzeVolume(data);
            const lastVolume = parseFloat(data[data.length - 1][5]);

            console.log(`RSI: ${rsi.toFixed(2)}, Avg Volume: ${avgVolume}, Last Volume: ${lastVolume}`);

            const [trend, probability] = predictTrend(rsi, avgVolume, lastVolume);

            // Kiểm tra dự đoán với giá thực tế
            const previousClose = parseFloat(data[data.length - 2][4]); // Giá đóng của nến trước
            const currentOpen = parseFloat(data[data.length - 1][1]);   // Giá mở của nến hiện tại
            const actualDirection = (currentOpen > previousClose) ? "Tăng" : "Giảm"; // Xu hướng thực tế dựa trên mở và đóng

            const isCorrect = (trend.includes(actualDirection)); // So sánh xu hướng dự đoán với xu hướng thực tế

            if (isCorrect) correctPredictions++;
            totalPredictions++;

            // Hiển thị mũi tên
            const arrow = (actualDirection === "Tăng") ? 
                `<span class="arrow up-arrow">↑</span>` : 
                `<span class="arrow down-arrow">↓</span>`;

            // Cập nhật hiển thị
            document.getElementById("result").innerHTML = `
                <p>RSI: ${rsi.toFixed(2)}, Dự đoán: ${trend} (${probability}%), Kết quả thực tế: ${actualDirection} ${arrow}</p>
            `;
            document.getElementById("accuracy").innerText = `Tỉ lệ thắng: ${(correctPredictions / totalPredictions * 100).toFixed(2)}%`;
        }

        async function syncPrediction() {
            const option = document.getElementById("option").value;
            const secondsToNextCandle = 7; // Thời gian còn lại đến nến tiếp theo

            // Chỉ thực hiện dự đoán nếu thời gian còn lại <= 5 giây
            if (secondsToNextCandle <= 5) {
                await makePrediction(option);
            }
        }

        function countdownTimer(initialTime, totalTime) {
            let timeRemaining = totalTime;

            countdownInterval = setInterval(() => {
                if (timeRemaining <= 0) {
                    clearInterval(countdownInterval);
                    return;
                }
                document.getElementById("countdownTimer").innerText = `Thời gian đến dự đoán: ${timeRemaining}s`;
                timeRemaining--;
            }, 1000);
        }

        function startAutoPrediction() {
            const interval = document.getElementById("chartInterval").value;
            const totalTime = (interval === "30s") ? 30 : 60; // 30 giây hoặc 1 phút
            countdownTimer(totalTime, totalTime);

            predictionInterval = setInterval(syncPrediction, 1000);
        }
    </script>
</body>
</html>
